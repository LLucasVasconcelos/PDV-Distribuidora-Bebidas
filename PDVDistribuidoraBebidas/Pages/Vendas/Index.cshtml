@page
@model IndexModel
@{
    ViewData["Title"] = "Histórico de Vendas";
}

<div class="container">
    <h2 class="my-4">Histórico de Vendas Realizadas</h2>

    @if (TempData["Mensagem"] != null)
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            @TempData["Mensagem"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @foreach (var grupo in Model.HistoricoAgrupado)
    {
        <div class="card mb-4 shadow-sm border-0">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-calendar-check"></i>
                    <strong>Compra em: @grupo.Data.ToString("dd/MM/yyyy HH:mm:ss")</strong>
                </span>
                <div>
                    <span class="badge bg-light text-dark fs-6 me-3">Total: @grupo.TotalVenda.ToString("C")</span>

                    @* Formulário de Cancelamento *@
                    <form method="post" asp-page-handler="CancelarCompra" style="display:inline;">
                        <input type="hidden" name="dataCompra" value="@grupo.Data.ToString("yyyy-MM-ddTHH:mm:ss.fff")" />
                        <button type="submit" class="btn btn-danger btn-sm"
                                onclick="return confirm('Deseja realmente cancelar toda esta compra? O estoque será devolvido.')">
                            <i class="bi bi-trash"></i> Cancelar Compra
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-secondary">
                        <tr>
                            <th class="ps-3">Produto</th>
                            <th>Qtd</th>
                            <th>Preço Un.</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in grupo.Itens)
                        {
                            <tr>
                                <td class="ps-3">@item.Produto?.Nome</td>
                                <td>@item.QuantidadeVendida</td>
                                <td>@((item.ValorTotal / item.QuantidadeVendida).ToString("C"))</td>
                                <td>@item.ValorTotal.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (!Model.HistoricoAgrupado.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Nenhuma venda registrada até o momento.
        </div>
    }
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
}